/*
 * Copyright 2019 Databricks, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.databricks.labs.gis.ml

import org.scalatest.{FlatSpec, Matchers}

class GeoUtilsTest extends FlatSpec with Matchers {

  "Optimal resolution" should "be derived from epsilon" in {
    GeoUtils.getOptimalResolution(1) should be(Some(15)) // 1m
    GeoUtils.getOptimalResolution(10) should be(Some(12)) // 10m
    GeoUtils.getOptimalResolution(100) should be(Some(10)) // 100m
    GeoUtils.getOptimalResolution(1000) should be(Some(8)) // 1km
    GeoUtils.getOptimalResolution(10000) should be(Some(5)) // 10km
    GeoUtils.getOptimalResolution(100000) should be(Some(3)) // 100km
    GeoUtils.getOptimalResolution(1000000) should be(Some(1)) // 100km
    GeoUtils.getOptimalResolution(10000000) should be(empty) // 1000km
  }

  "A circle of 10 meters" should "be covered with 7 tiles of precision 12" in {
    val h3 = GeoPoint(40.7128, -74.0060).toH3(12)
    GeoUtils.fillRadius(h3, 10).length should be(7)
  }

  "Distance between 2 points" should "be expressed in meters" in {
    val p1 = GeoPoint(40.7128, -74.0060)
    val p2 = GeoPoint(40.7128, -75.0060)
    assert(GeoUtils.haversine(p1, p2) < 100000)
  }

  "A geocoordinate" should "be encoded in h3" in {
    val pt = GeoPoint(40.712800, -74.005996)
    pt.toH3(15) should be(644754748784796037L)
  }

  "A circle" should "be covered in h3" in {
    val pt1 = GeoPoint(40.712800, -74.005996).toH3(9)
    GeoUtils.fillRadius(pt1, 100).size should be(7)
    val pt2 = GeoPoint(40.712800, -74.005996).toH3(8)
    GeoUtils.fillRadius(pt2, 2000).size should be(26)
  }

  "A polygon" should "be covered with h3 tiles" in {
    import collection.JavaConverters._
    val pt = GeoPoint(40.78411592042219, -73.94991874694824).toH3(9)

    // Instead of creating a random polygon, we create a polygon for a H3 point at low resolution..
    val polygon = GeoUtils.convexHull(H3.instance.h3ToGeoBoundary(pt).asScala.toList.map(n => n.toGeoPoint))

    // that we fill with H3 of higher resolution. A first layer should contain a center and 6 neighbours
    GeoUtils.polyFill(polygon, 10, 0).size should be(7)
    GeoUtils.polyFill(polygon, 10, 1).size should be(19)
    GeoUtils.polyFill(polygon, 10, 2).size should be(37)
  }

  "A polygon" should "be expanded" in {

    val polygon = GeoShape.fromGeoJson("""{"type":"FeatureCollection","features":[{"type":"Feature","id":0,"properties":{"name":"CLUSTER-0"},"geometry":{"type":"Polygon","coordinates":[[[-73.9961354408675,40.70923907520798],[-73.98041743632189,40.711282577888575],[-73.97921357520357,40.71174652511813],[-73.97787313431672,40.71318489309429],[-73.97783163830076,40.71323994360293],[-73.93384763181234,40.79486747652509],[-73.93331890862564,40.79590720843451],[-73.93164466840365,40.800162518982354],[-73.93829317043676,40.80824638261313],[-73.93969935939553,40.80842496090929],[-73.95549694882354,40.80757175393827],[-73.9959254649367,40.76929023087033],[-74.00616333456223,40.75638430928875],[-74.00850184341243,40.75146429156862],[-74.00886245916911,40.75064510472805],[-74.00918495049932,40.74556447157256],[-74.0067292357363,40.71887459961128],[-74.0063877230327,40.71796699318104],[-73.9961354408675,40.70923907520798]]]}},{"type":"Feature","id":1,"properties":{"name":"CLUSTER-1"},"geometry":{"type":"Polygon","coordinates":[[[-73.98128322754359,40.77589289760022],[-73.9793834270222,40.77648386641938],[-73.97728002355588,40.77745810918435],[-73.96446798309607,40.79081126686167],[-73.9622350509522,40.79411014031907],[-73.96338022021926,40.8022315151837],[-73.96384209783074,40.80286701567196],[-73.9669044937486,40.80516049177788],[-73.96759923461671,40.80503386219619],[-73.96880978456355,40.80467741148234],[-73.97157990138187,40.80282127986246],[-73.97199991888382,40.80237806502621],[-73.98331163843483,40.78193736587754],[-73.98254000398254,40.77785601965758],[-73.98128322754359,40.77589289760022]]]}},{"type":"Feature","id":2,"properties":{"name":"CLUSTER-2"},"geometry":{"type":"Polygon","coordinates":[[[-73.95843307756228,40.72061122832746],[-73.94881510874083,40.72135414209403],[-73.94451265780867,40.72184661432903],[-73.94088581357515,40.726312196563136],[-73.94076116400309,40.72647733252284],[-73.94113476248242,40.72711462742008],[-73.94243006761228,40.72902188391755],[-73.94436523864951,40.730534516850284],[-73.9462465913343,40.73177888068385],[-73.95058307851087,40.732148481018854],[-73.95150106623426,40.73217787270851],[-73.95877413647537,40.72831511100489],[-73.9593721191133,40.726842712093],[-73.96008609948863,40.7227243083088],[-73.95969562343001,40.72165606760388],[-73.95843307756228,40.72061122832746]]]}},{"type":"Feature","id":3,"properties":{"name":"CLUSTER-3"},"geometry":{"type":"Polygon","coordinates":[[[-73.94834715185604,40.73986837298157],[-73.94599568582373,40.7400390640113],[-73.94482820779237,40.740339960021466],[-73.94184917098715,40.74122862852768],[-73.93776459641875,40.74290194045973],[-73.93753575394284,40.74377121520269],[-73.93700312617513,40.74583548791187],[-73.93700723857876,40.745943279686145],[-73.93922038136654,40.75014657901929],[-73.93972298397813,40.75072668546132],[-73.94539418193267,40.75510778025542],[-73.94725172689175,40.75570569572999],[-73.9485068469274,40.755402393421],[-73.94928402290594,40.75516580428507],[-73.9504186928995,40.754002386568985],[-73.95919891035108,40.74270696892943],[-73.95967660273374,40.74150727914811],[-73.95857969182599,40.74024192422167],[-73.94834715185604,40.73986837298157]]]}},{"type":"Feature","id":4,"properties":{"name":"CLUSTER-4"},"geometry":{"type":"Polygon","coordinates":[[[-73.94315907279733,40.81540628898192],[-73.94074531575039,40.816334494048505],[-73.93977505262215,40.81841226131103],[-73.94319387906644,40.82544958313483],[-73.94346849219114,40.825766301484734],[-73.94765521392516,40.82770699146598],[-73.9496281103982,40.8278164076739],[-73.95063122654814,40.82773564237494],[-73.9520050841681,40.823648591424245],[-73.95221743399229,40.82234684144156],[-73.95221327986984,40.82223894652169],[-73.94479016762254,40.81574083833872],[-73.9445655002118,40.815584828456316],[-73.94315907279733,40.81540628898192]]]}},{"type":"Feature","id":5,"properties":{"name":"CLUSTER-5"},"geometry":{"type":"Polygon","coordinates":[[[-73.98809387844882,40.69225572109289],[-73.98650891798883,40.69299956813119],[-73.98020705326593,40.69807663384935],[-73.98044570766233,40.70195255969759],[-73.98085333544117,40.70345140978525],[-73.9813102743168,40.70397830685029],[-73.98232335693822,40.704220549727026],[-73.98354385980775,40.70418755148814],[-73.98742119941843,40.70402871098376],[-73.99094981127836,40.70387919334354],[-73.99137300205595,40.703544171994636],[-73.9915718932306,40.70305345796793],[-73.99173267160879,40.7015931506074],[-73.99162258873103,40.6987921620252],[-73.98827241726369,40.692358718685014],[-73.98809387844882,40.69225572109289]]]}},{"type":"Feature","id":6,"properties":{"name":"CLUSTER-6"},"geometry":{"type":"Polygon","coordinates":[[[-73.94169082943995,40.82732575494144],[-73.94117877535912,40.827663411076145],[-73.94079576217938,40.8279436281424],[-73.94067084216029,40.828108968830875],[-73.9403834861661,40.82860266777027],[-73.94026269015238,40.828875912941676],[-73.94015014663574,40.82936496731959],[-73.94017078169921,40.82990449093252],[-73.94026232065936,40.83001007192662],[-73.94057858227491,40.830271700334386],[-73.94129852969115,40.83079263237017],[-73.94174385801317,40.83099681950718],[-73.94196445803827,40.831044959320444],[-73.94244316797739,40.83097821490109],[-73.9432257572971,40.830849373213695],[-73.94444127222944,40.83060098429344],[-73.94451627391443,40.83027493941209],[-73.94454550006267,40.829896106943124],[-73.94456645144294,40.829301467347136],[-73.94455817722238,40.82908565902923],[-73.94450412967963,40.82881706316193],[-73.94431690063922,40.82849800753153],[-73.9442711278741,40.82844521956502],[-73.94297682926789,40.827777589887766],[-73.94226517182499,40.82747249172707],[-73.94169082943995,40.82732575494144]]]}},{"type":"Feature","id":7,"properties":{"name":"CLUSTER-7"},"geometry":{"type":"Polygon","coordinates":[[[-74.01346035006402,40.701541224397964],[-74.01167541499116,40.70164386716879],[-74.00978322877849,40.702342579481176],[-74.00603710110956,40.70470954946836],[-74.0048220314807,40.70598295164073],[-74.00272766632183,40.70819706372489],[-74.00152093469111,40.709685969782356],[-74.00300003510222,40.71067040624378],[-74.00388899803835,40.71107766123945],[-74.00574442061557,40.71054178015417],[-74.01409764338979,40.7065929003248],[-74.01446213189382,40.70259236984959],[-74.01413344311909,40.702008168983745],[-74.01346035006402,40.701541224397964]]]}},{"type":"Feature","id":8,"properties":{"name":"CLUSTER-8"},"geometry":{"type":"Polygon","coordinates":[[[-73.94997962713902,40.81193068973289],[-73.94997962713902,40.81193068973289],[-73.94952185439472,40.81253686023492],[-73.94952185439472,40.81253686023492],[-73.95289181104864,40.81941272811119],[-73.95468541343931,40.820552848700615],[-73.955725823761,40.82030903736305],[-73.9564582643706,40.82001944937703],[-73.9586014171149,40.81888210559547],[-73.95909657851492,40.818112846821634],[-73.95885509370333,40.81639131282251],[-73.95623759910846,40.81316743942407],[-73.9516938855676,40.81215491297626],[-73.9507244183871,40.81196480892085],[-73.94997962713902,40.81193068973289]]]}},{"type":"Feature","id":9,"properties":{"name":"CLUSTER-9"},"geometry":{"type":"Polygon","coordinates":[[[-73.92883261715265,40.77103553931587],[-73.92774338981182,40.77111839574238],[-73.92723185396191,40.771455763009605],[-73.92612003606534,40.77439952410228],[-73.9261657351025,40.77445228228849],[-73.92721684176344,40.77566572572442],[-73.92767386188105,40.77619331290719],[-73.92909132936786,40.776695429285866],[-73.92957359672066,40.776736606623814],[-73.93391404925043,40.777107113980954],[-73.9352694605853,40.777125067712],[-73.93574351564394,40.77695055205004],[-73.93599311636257,40.776620088106945],[-73.93629711792937,40.77542464564286],[-73.936347870401,40.77331847403524],[-73.93500539396975,40.77249066388646],[-73.9346936632665,40.77233704403275],[-73.93010874133928,40.77127151641865],[-73.92883261715265,40.77103553931587]]]}},{"type":"Feature","id":10,"properties":{"name":"CLUSTER-10"},"geometry":{"type":"Polygon","coordinates":[[[-73.94839231901437,40.770622950851866],[-73.94791423045635,40.77068968111355],[-73.9453613210857,40.77248478551412],[-73.94354414642734,40.77409834831575],[-73.94374325940336,40.7758740709205],[-73.94487417156911,40.77573598059108],[-73.94892807449408,40.77433251945593],[-73.94905696582305,40.774275107712526],[-73.94911527493295,40.773517968869456],[-73.9487040865245,40.770776531172004],[-73.94839231901437,40.770622950851866]]]}},{"type":"Feature","id":11,"properties":{"name":"CLUSTER-11"},"geometry":{"type":"Polygon","coordinates":[[[-73.97100826069082,40.772391624842825],[-73.97100826069082,40.772391624842825],[-73.96996932690556,40.77376882508211],[-73.96996932690556,40.77376882508211],[-73.9700650164464,40.77398213767295],[-73.97043101608796,40.774404069971474],[-73.97070132777138,40.77461268913091],[-73.97122937748897,40.77470643396123],[-73.97179479196089,40.77463725601101],[-73.97227289571279,40.77457042401823],[-73.9724848741838,40.774402806261996],[-73.97310400917878,40.77346863446995],[-73.97243451748089,40.773108850742254],[-73.97100826069082,40.772391624842825]]]}},{"type":"Feature","id":12,"properties":{"name":"CLUSTER-12"},"geometry":{"type":"Polygon","coordinates":[[[-73.95129540342118,40.70980054356982],[-73.95120821484117,40.70980287669692],[-73.95125802210534,40.70996332493653],[-73.95157353997133,40.71022451727384],[-73.95282327592584,40.70981357475077],[-73.95129540342118,40.70980054356982]]]}},{"type":"Feature","id":13,"properties":{"name":"CLUSTER-13"},"geometry":{"type":"Polygon","coordinates":[[[-73.96196235075982,40.807398722097076],[-73.96196235075982,40.807398722097076],[-73.96196235075982,40.807398722097076],[-73.96249492481238,40.80760042675216],[-73.96196235075982,40.807398722097076]]]}},{"type":"Feature","id":14,"properties":{"name":"CLUSTER-14"},"geometry":{"type":"Polygon","coordinates":[[[-73.95501542982424,40.711210908890564],[-73.95501542982424,40.711210908890564],[-73.95501542982424,40.711210908890564],[-73.95501542982424,40.711210908890564]]]}}]}""")
    val points = polygon.clusters.head.points

    val t0 = GeoUtils.polyFill(points, 9, 0).toSet
    val t1 = GeoUtils.polyFill(points, 9, 1).toSet.filter(t => !t0.contains(t))
    val t2 = GeoUtils.polyFill(points, 9, 2).toSet.filter(t => !t1.contains(t) && !t0.contains(t))

    t0.foreach(p => println(f"0,${p}%X"))
    t1.foreach(p => println(f"1,${p}%X"))
    t2.foreach(p => println(f"2,${p}%X"))
    println(GeoShape(List(GeoCluster(0, points))).toGeoJson)

  }



}
